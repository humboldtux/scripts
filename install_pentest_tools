#!/usr/bin/env bash

# TODO
# https://github.com/hakluke
# https://github.com/lc
# https://github.com/projectdiscovery
# https://github.com/tomnomnom
# https://github.com/six2dez/reconftw/blob/main/install.sh
# https://thibaud-robin.fr/articles/docker-kali

DEB_PKGS="nmap rlwrap socat ncat netcat-traditional john fcrackzip smbmap smbclient hydra cewl nikto 2to3 hashcat checksec edb-debugger sshpass dnsenum"
echo "Installation apt ${DEB_PKGS}"
sudo apt-get install -y ${DEB_PKGS} > /dev/null

if ! dpkg-query -W -f='${Status}' metasploit-framework > /dev/null
then
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall
fi
if [[ ! -L /opt/metasploit-framework/embedded/share/terminfo/x/xterm-kitty ]]; then
  sudo ln -s /usr/share/terminfo/x/xterm-kitty /opt/metasploit-framework/embedded/share/terminfo/x/xterm-kitty
fi

if [[ ! -d /opt/john-jumbo ]]; then
  sudo git clone --depth 1 https://github.com/magnumripper/JohnTheRipper /opt/john-jumbo
  cd /opt/john-jumbo/src && sudo ./configure && sudo make -s clean && sudo make -sj4
fi

if ! dpkg-query -W -f='${Status}' stegseek > /dev/null
then
  wget -q $(curl -sL https://api.github.com/repos/RickdeJager/stegseek/releases/latest | jq -r '.assets[].browser_download_url') \
    -O /tmp/stegseek.deb && sudo apt-get install -y /tmp/stegseek.deb > /dev/null
fi

sudo gem install wpscan evil-winrm --no-doc > /dev/null

if [[ ! -f /usr/local/bin/revshellgen.py ]]; then
  sudo wget -q https://raw.githubusercontent.com/cwinfosec/revshellgen/master/revshellgen.py -O /usr/local/bin/revshellgen.py
  sudo chmod +x /usr/local/bin/revshellgen.py
fi

sudo mkdir -p /opt/wordlists
if [[ ! -d /opt/wordlists/SecLists ]]; then
  echo "Clone SecLists"
  sudo git clone -q --depth 1 https://github.com/danielmiessler/SecLists.git /opt/wordlists/SecLists
fi
if [[ ! -f /opt/wordlists/rockyou.txt ]]; then
  echo "Download Rockyou"
  wget -q https://download.weakpass.com/wordlists/90/rockyou.txt.gz && gunzip rockyou.txt.gz && sudo mv rockyou.txt /opt/wordlists/
fi
if [[ ! -f /opt/wordlists/hob064.rule ]]; then
  echo "Download HoboRules"
  sudo wget -q https://raw.githubusercontent.com/praetorian-inc/Hob0Rules/master/hob064.rule -o /opt/wordlists/hob064.rule
fi

sudo mkdir -p /opt/revshells
if [[ ! -d /opt/revshells/nishang ]]; then
  echo "Clone nishang"
  sudo git clone -q --depth 1 https://github.com/samratashok/nishang /opt/revshells/nishang
fi

if [[ ! -d /opt/revshells/tennc ]]; then
  echo "Clone tennc webshells"
  sudo git clone -q --depth 1 https://github.com/tennc/webshell /opt/revshells/tennc
fi

if [[ ! -d /opt/revshells/ivan-sincek-powershell-tcp ]]; then
  echo "Clone Ivan Sincek powershells"
  sudo git clone -q --depth 1 https://github.com/ivan-sincek/powershell-reverse-tcp /opt/revshells/ivan-sincek-powershell-tcp
fi

if [[ ! -d /opt/revshells/ivan-sincek-php-reverse-shell ]]; then
  echo "Clone Ivan Sincek webshells"
  sudo git clone -q --depth 1 https://github.com/ivan-sincek/php-reverse-shell /opt/revshells/ivan-sincek-php-reverse-shell
fi

if [[ ! -f /opt/revshells/pentestmonkey-revshell.php ]]; then
  echo "Clone PentestMonkey RevShell"
  sudo wget -q https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O /opt/revshells/pentestmonkey-revshell.php
fi

if [[ ! -d /opt/weevely3 ]]; then
  echo "Clone weevely"
  sudo git clone --depth 1 https://github.com/epinna/weevely3 /opt/weevely3
  cd /opt/weevely3 && sudo pip3 install -r requirements.txt --upgrade
  sudo ln -s /opt/weevely3/weevely.py /usr/local/bin/.
fi

if [[ ! -d /opt/exploitdb ]]; then
  echo "installing searchsploit"
  sudo git clone --depth 1 https://github.com/offensive-security/exploitdb.git /opt/exploitdb
  sudo ln -sf /opt/exploitdb/searchsploit /usr/local/bin/searchsploit
fi

if [[ ! -d /opt/Responder ]]; then
  echo "installing Responder"
  sudo git clone -q --depth 1 https://github.com/lgandx/Responder /opt/Responder
fi

if [[ ! -f "${HOME}/bin/massdns" ]];then
  echo "Installing MassDns"
  git clone -q --depth 1 https://github.com/blechschmidt/massdns.git /tmp/massdns
  make -C /tmp/massdns/ > /dev/null
  mv /tmp/massdns/bin/massdns ${HOME}/bin/massdns
fi

PKGS_GO="github.com/ffuf/ffuf \
  github.com/OWASP/Amass/v3/... \
  github.com/tomnomnom/httprobe \
  github.com/0xsha/GoLinkFinder \
  github.com/003random/getJS \
  github.com/projectdiscovery/subfinder/v2/cmd/subfinder \
  github.com/haccer/subjack \
  github.com/jpillora/chisel \
  github.com/utkusen/urlhunter \
  github.com/m4dm0e/dirdar \
  github.com/lukasikic/subzy \
  github.com/ropnop/kerbrute \
  github.com/OJ/gobuster/v3@latest \
  github.com/zricethezav/gitleaks"

echo "Installation go get"
for PKG in ${PKGS_GO}; do
  go get ${PKG}
done

PIPX_PKGS="sublist3r dnsgen arjun pwncat sqlmap awscli search-that-hash sshuttle pypykatz crackmapexec impacket lsassy bloodhound pwntools git-dumper"
echo "Installation logiciels pipx: ${PIPX_PKGS}"
for PKG in ${PIPX_PKGS}; do
  if [[ ! -d "${HOME}/.local/pipx/venvs/${PKG}" ]];then
    pipx install ${PKG} >  /dev/null
  fi
done

echo "Installation pkgs cargo"
CARGO_PKGS="lychee feroxbuster rustscan findomain"
for PKG in ${CARGO_PKGS}; do
  cargo --quiet install ${PKG}
done
asdf reshim rust

NIX_PKGS="hydra enum4linux enum4linux-ng dnsrecon"
#sudo -E sh -c 'echo 1 > /proc/sys/vm/overcommit_memory' # probleme memoire
for PKG in ${NIX_PKGS}; do
  if [[ ! -L "${HOME}/.nix-profile/bin/${PKG}" ]]; then
    echo "Installation pkg nix ${PKG}"
    nix-env --quiet -i ${PKG} > /dev/null
  fi
done
