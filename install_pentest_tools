#!/usr/bin/env bash

# TODO
# https://github.com/hakluke
# https://github.com/lc
# https://github.com/projectdiscovery
# https://github.com/tomnomnom
# https://github.com/six2dez/reconftw/blob/main/install.sh
# https://thibaud-robin.fr/articles/docker-kali
# https://github.com/s-h-3-l-l/katoolin3
# https://twitter.com/ScriptKKiddie/status/1428080120997294083

#SETUP
if [[ $1 == '-u' ]];then
  GO='go get -u'
  WGET='wget -N' # only download if version is newer
else
  WGET='wget --no-clobber' #only download if file does not exist
  GO='go get'
fi

source ${HOME}/.bash_functions
#END SETUP

DEB_PKGS="2to3 cewl checksec dnsenum edb-debugger fcrackzip hashcat hydra john ncat netcat-traditional nikto nmap rlwrap smbclient smbmap socat sshpass"
echo "Installation apt ${DEB_PKGS}"
sudo apt-get install -y ${DEB_PKGS} > /dev/null

if ! dpkg-query -W -f='${Status}' metasploit-framework > /dev/null
then
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall
fi
if [[ ! -L /opt/metasploit-framework/embedded/share/terminfo/x/xterm-kitty ]]; then
  sudo ln -s /usr/share/terminfo/x/xterm-kitty /opt/metasploit-framework/embedded/share/terminfo/x/xterm-kitty
fi

if [[ ! -d /opt/john-jumbo ]]; then
  sudo git clone --depth 1 https://github.com/magnumripper/JohnTheRipper /opt/john-jumbo
  sudo chown -R $USERNAME /opt/john-jumbo
  gita add /opt/john-jumbo
  cd /opt/john-jumbo/src && sudo ./configure && sudo make -s clean && sudo make -sj4
  if [[ $1 == '-u' ]];then
    gita pull /opt/john-jumbo
    cd /opt/john-jumbo/src && sudo ./configure && sudo make -s clean && sudo make -sj4
  fi
fi

if ! dpkg-query -W -f='${Status}' stegseek > /dev/null
then
  wget -q $(curl -sL https://api.github.com/repos/RickdeJager/stegseek/releases/latest | jq -r '.assets[].browser_download_url') \
    -O /tmp/stegseek.deb && sudo apt-get install -y /tmp/stegseek.deb > /dev/null
fi

sudo gem install wpscan evil-winrm --no-doc --no-document > /dev/null

sudo ${WGET} -q https://raw.githubusercontent.com/cwinfosec/revshellgen/master/revshellgen.py -O /usr/local/bin/revshellgen.py && \
  sudo chmod +x /usr/local/bin/revshellgen.py

sudo mkdir -p /opt/wordlists && sudo chown $USERNAME /opt/wordlists
sudo chgrp sudo /opt && sudo chmod g+rwx /opt

if [[ ! -d /opt/wordlists/SecLists ]]; then
  echo "Clone SecLists"
  git clone -q --depth 1 https://github.com/danielmiessler/SecLists.git /opt/wordlists/SecLists
  gita add /opt/wordlists/SecLists
fi

if [[ ! -f /opt/wordlists/rockyou.txt || $1 == '-u' ]]; then
  echo "Download Rockyou"
  ${WGET} -q https://download.weakpass.com/wordlists/90/rockyou.txt.gz -O /opt/wordlists/rockyou.txt.gz && gunzip -q -f /opt/wordlists/rockyou.txt.gz
fi

echo "Download HoboRules"
${WGET} -q https://raw.githubusercontent.com/praetorian-inc/Hob0Rules/master/hob064.rule -o /opt/wordlists/hob064.rule

sudo mkdir -p /opt/revshells &&  sudo chown $USERNAME /opt/revshells
if [[ ! -d /opt/revshells/nishang ]]; then
  echo "Clone nishang"
  git clone -q --depth 1 https://github.com/samratashok/nishang /opt/revshells/nishang
  gita add /opt/revshells/nishang
fi

if [[ ! -d /opt/revshells/tennc ]]; then
  echo "Clone tennc webshells"
  git clone -q --depth 1 https://github.com/tennc/webshell /opt/revshells/tennc
  gita add /opt/revshells/tennc
fi

if [[ ! -d /opt/revshells/ivan-sincek-powershell-tcp ]]; then
  echo "Clone Ivan Sincek powershells"
  git clone -q --depth 1 https://github.com/ivan-sincek/powershell-reverse-tcp /opt/revshells/ivan-sincek-powershell-tcp
  gita add /opt/revshells/ivan-sincek-powershell-tcp
fi

if [[ ! -d /opt/revshells/ivan-sincek-php-reverse-shell ]]; then
  echo "Clone Ivan Sincek webshells"
  git clone -q --depth 1 https://github.com/ivan-sincek/php-reverse-shell /opt/revshells/ivan-sincek-php-reverse-shell
  gita add /opt/revshells/ivan-sincek-powershell-tcp
fi

if [[ ! -d /opt/revshells/phpbash ]]; then
  echo "Clone phpbash"
  git clone -q --depth 1 https://github.com/Arrexel/phpbash /opt/revshells/phpbash
  gita add /opt/revshells/phpbash
fi


echo "Clone PentestMonkey RevShell"
${WGET} -q https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O /opt/revshells/pentestmonkey-revshell.php

if [[ ! -d /opt/weevely3 ]]; then
  echo "Clone weevely"
  git clone --depth 1 https://github.com/epinna/weevely3 /opt/weevely3
  gita add /opt/weevely3
  cd /opt/weevely3 && pip3 install -r requirements.txt --upgrade
  sudo ln -s /opt/weevely3/weevely.py /usr/local/bin/.
fi

if [[ ! -d /opt/exploitdb ]]; then
  echo "installing searchsploit"
  git clone --depth 1 https://github.com/offensive-security/exploitdb.git /opt/exploitdb
  gita add /opt/exploitdb
  sudo ln -sf /opt/exploitdb/searchsploit /usr/local/bin/.
fi

if [[ ! -d /opt/Responder ]]; then
  echo "installing Responder"
  git clone -q --depth 1 https://github.com/lgandx/Responder /opt/Responder
  gita add /opt/Responder
fi

if [[ ! -d /opt/massdns ]];then
  echo "Installing MassDns"
  git clone -q --depth 1 https://github.com/blechschmidt/massdns.git /opt/massdns
  gita add /opt/massdns
  make -C /opt/massdns/ > /dev/null
  sudo ln -sf /opt/massdns/bin/massdns /usr/local/bin/.
  if [[ $1 == '-u' ]];then
    gita pull /opt/massdns
    make -C /opt/massdns/ > /dev/null
  fi
fi

PKGS_GO="github.com/ffuf/ffuf \
  github.com/OWASP/Amass/v3/... \
  github.com/tomnomnom/httprobe \
  github.com/0xsha/GoLinkFinder \
  github.com/003random/getJS \
  github.com/projectdiscovery/subfinder/v2/cmd/subfinder \
  github.com/haccer/subjack \
  github.com/jpillora/chisel \
  github.com/utkusen/urlhunter \
  github.com/m4dm0e/dirdar \
  github.com/lukasikic/subzy \
  github.com/ropnop/kerbrute \
  github.com/OJ/gobuster/v3@latest \
  github.com/hakluke/hakrawler \
  github.com/zricethezav/gitleaks"

echo "Installation go get"
for PKG in ${PKGS_GO}; do
  ${GO} ${PKG}
done

PIPX_PKGS="sublist3r dnsgen arjun pwncat sqlmap awscli name-that-hash search-that-hash sshuttle pypykatz crackmapexec impacket lsassy bloodhound pwntools git-dumper"
echo "Installation logiciels pipx: ${PIPX_PKGS}"
for PKG in ${PIPX_PKGS}; do
  if [[ ! -d "${HOME}/.local/pipx/venvs/${PKG}" ]];then
    pipx install ${PKG} >  /dev/null
  fi
done

echo "Installation pkgs cargo"
CARGO_PKGS="lychee feroxbuster rustscan"
for PKG in ${CARGO_PKGS}; do
  cargo --quiet install ${PKG}
done
asdf reshim rust

NIX_PKGS="enum4linux enum4linux-ng dnsrecon"
#sudo -E sh -c 'echo 1 > /proc/sys/vm/overcommit_memory' # probleme memoire
for PKG in ${NIX_PKGS}; do
  if [[ ! -L "${HOME}/.nix-profile/bin/${PKG}" ]]; then
    echo "Installation pkg nix ${PKG}"
    nix-env --quiet -i ${PKG} > /dev/null
  fi
done

#/opt/binaries
ROOTDIR="/opt/binaries"
LINUXDIR="${ROOTDIR}/linux"
WINDOWSDIR="${ROOTDIR}/windows"

sudo mkdir -p ${LINUXDIR} ${WINDOWSDIR}

echo "Starting retrieving Linux resources /opt/binaries/linux"
cd ${LINUXDIR}
sudo ${WGET} -q `github_get_latest_dwd jpillora/chisel linux_amd64` -O /tmp/chisel_linux_amd64.gz && sudo gunzip -q -k -c /tmp/chisel_linux_amd64.gz > /tmp/chisel64 && sudo mv /tmp/chisel64 .
sudo ${WGET} -q `github_get_latest_dwd jpillora/chisel linux_386` -O /tmp/chisel_linux_386.gz && sudo gunzip -q -k -c /tmp/chisel_linux_386.gz > /tmp/chisel32 && sudo mv /tmp/chisel32 .
sudo ${WGET} -q https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh -O linpeas.sh
sudo ${WGET} -q https://raw.githubusercontent.com/jondonas/linux-exploit-suggester-2/master/linux-exploit-suggester-2.pl -O linux-exploit-suggester-2.pl
sudo ${WGET} -q https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O linux-exploit-suggester.sh
sudo ${WGET} -q https://raw.githubusercontent.com/sleventyeleven/linuxprivchecker/master/linuxprivchecker.py -O linuxprivchecker.py
sudo ${WGET} -q https://github.com/ernw/static-toolbox/releases/download/nmap-v7.91SVN/nmap-7.91SVN-x86_64-portable.tar.gz
sudo ${WGET} -q https://github.com/ernw/static-toolbox/releases/download/nmap-v7.91SVN/nmap-7.91SVN-x86-portable.tar.gz
sudo ${WGET} -q https://github.com/ernw/static-toolbox/releases/download/socat-v1.7.4.1/socat-1.7.4.1-x86_64 -O socat64
sudo ${WGET} -q https://github.com/ernw/static-toolbox/releases/download/socat-v1.7.4.1/socat-1.7.4.1-x86 -O socat32
sudo ${WGET} -q https://raw.githubusercontent.com/diego-treitos/linux-smart-enumeration/master/lse.sh -O lse.sh
sudo ${WGET} -q https://raw.githubusercontent.com/Anon-Exploiter/SUID3NUM/master/suid3num.py -O suid3num.py
sudo ${WGET} -q https://raw.githubusercontent.com/TH3xACE/SUDO_KILLER/master/extract.sh -O sudo-extractor.sh
sudo ${WGET} -q https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy32s -O pspy32s
sudo ${WGET} -q https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64s -O pspy64s
sudo ${WGET} -q https://raw.githubusercontent.com/stealthcopter/deepce/main/deepce.sh -O deepce.sh
sudo chmod a+x ${LINUXDIR}/*

echo "Starting retrieving Windows resources /opt/binaries/windows"
cd ${WINDOWSDIR}
sudo ${WGET} -q https://sourceforge.net/projects/unix-utils/files/socat/1.7.3.2/socat-1.7.3.2-1-x86_64.zip/download -O /tmp/socat-1.7.3.2-1-x86_64.zip && sudo unzip -qjo /tmp/socat-1.7.3.2-1-x86_64.zip socat-1.7.3.2-1-x86_64/socat.exe && sudo mv socat.exe socat64.exe
sudo ${WGET} -q https://sourceforge.net/projects/unix-utils/files/socat/1.7.3.2/socat-1.7.3.2-1-i686.zip/download -O /tmp/socat-1.7.3.2-1-i686.zip && sudo unzip -qjo /tmp/socat-1.7.3.2-1-i686.zip socat-1.7.3.2-1-i686/socat.exe && sudo mv socat.exe socat32.exe
sudo ${WGET} -q `github_get_latest_dwd jpillora/chisel windows_386` -O /tmp/chisel_windows_386.gz && sudo gunzip -q -k -c /tmp/chisel_windows_386.gz > /tmp/chisel32.exe && sudo mv /tmp/chisel32.exe .
sudo ${WGET} -q `github_get_latest_dwd jpillora/chisel windows` -O /tmp/chisel_windows_amd64.gz && sudo gunzip -q -k -c /tmp/chisel_windows_amd64.gz > /tmp/chisel64.exe && sudo mv /tmp/chisel64.exe .
sudo ${WGET} -q https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASexe/binaries/Obfuscated%20Releases/winPEASx64.exe -O winPEASx64.exe
sudo ${WGET} -q https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASexe/binaries/Obfuscated%20Releases/winPEASx86.exe -O winPEASx86.exe
sudo ${WGET} -q https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASexe/binaries/Obfuscated%20Releases/winPEASany.exe -O winPEASany.exe
sudo ${WGET} -q https://nmap.org/dist/ncat-portable-5.59BETA1.zip -O /tmp/ncat-portable-5.59BETA1.zip && sudo unzip -qjo /tmp/ncat-portable-5.59BETA1.zip ncat-portable-5.59BETA1/ncat.exe
sudo ${WGET} -q `github_get_latest_dwd gentilkiwi/mimikatz mimikatz_trunk.zip` -O /tmp/mimikatz_trunk.zip && sudo unzip -qu /tmp/mimikatz_trunk.zip -d mimikatz
sudo ${WGET} -q https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASbat/winPEAS.bat -O winPEAS.bat
sudo ${WGET} -q https://raw.githubusercontent.com/MScholtes/TechNet-Gallery/master/Powershell%20Webserver/Start-WebServer.ps1 -O Start-WebServer.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1 -O Invoke-Mimikatz.ps1
sudo ${WGET} -q https://download.sysinternals.com/files/AccessChk.zip -O /tmp/AccessChk.zip && sudo unzip -qo /tmp/AccessChk.zip accesschk*
sudo ${WGET} -q https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1 -O Import-ActiveDirectory.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1 -O PowerView.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.exe -O SharpHound.exe
sudo ${WGET} -q https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.ps1 -O SharpHound.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1 -O PrivescCheck.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1 -O powercat.ps1
sudo ${WGET} -q https://raw.githubusercontent.com/trustedsec/unicorn/master/unicorn.py -O unicorn.py
sudo ${WGET} -q https://the.earth.li/~sgtatham/putty/latest/w32/plink.exe -O plinkw32.exe
sudo ${WGET} -q https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe -O plinkw64.exe
sudo ${WGET} -q https://github.com/int0x33/nc.exe/raw/master/nc64.exe -O nc64.exe
sudo ${WGET} -q https://github.com/int0x33/nc.exe/raw/master/nc.exe -O nc.exe
sudo ${WGET} -q `github_get_latest_dwd hlldz/dazzleUP dazzleUP.x64.exe`
if [[ ! -d 'SharpCollection' ]]; then
  sudo git clone --quiet --depth 1 https://github.com/Flangvik/SharpCollection
  if [[ $1 == '-u' ]];then
    cd SharpCollection && sudo git pull --quiet
  fi
fi
